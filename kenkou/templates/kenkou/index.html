{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>進捗</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'top.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .progress-chart {
            width: 140px;
            height: 140px;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>

<body>
<div class="app-container">
<!-- ===== ナビ ===== -->
<!-- <ul>
    <li><a href="{% url 'kenkou:mission' %}">ミッション</a></li>
    <li><a href="{% url 'kenkou:battle' %}">たたかう</a></li>
    <li><a href="{% url 'kenkou:logs' %}">ログを見る</a></li>
</ul> -->

<ul>
    <li><a href="{% url 'kenkou:mission' %}"><i class="fa-solid fa-circle-question"></i>ミッション</a></li>
    <li><a href="{% url 'kenkou:battle' %}"><i class="fa-solid fa-khanda"></i>たたかう</a></li>
    <li><a href="{% url 'kenkou:logs' %}"><i class="fa-solid fa-file-lines"></i>ログ</a></li>
</ul>

<!-- ===== 目標設定 ===== -->
<form id="goal-form">
    <input type="number" id="goalInput" placeholder="目標距離(m)">
    <button>設定</button>
</form>

<p id="goal">今日の目標：{{ goal_distance }} m</p>
<p id="distance">今日の合計距離：{{ total_distance }} m</p>

<!-- ===== 円グラフ ===== -->
<canvas id="progressChart" class="progress-chart"></canvas>

<script>
let lastLat = null;
let lastLon = null;

let totalDistance = {{ total_distance }};
let goalDistance = {{ goal_distance }};

/* ===== 中央テキストプラグイン ===== */
const centerTextPlugin = {
    id: "centerText",
    beforeDraw(chart) {
        const { ctx, width, height } = chart;
        const text = chart.config.data.centerText || "0%";
        ctx.save();
        // ctx.font = "bold 20px sans-serif";
        ctx.font = "bold 40px sans-serif";
        ctx.fillStyle = "#111";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, width / 2, height / 2);
        ctx.restore();
    }
};

/* ===== Chart 初期化（1回だけ） ===== */
const ctx = document.getElementById("progressChart").getContext("2d");
const progressChart = new Chart(ctx, {
    type: "doughnut",
    data: {
        datasets: [{
            data: [0, goalDistance],
            backgroundColor: ["#4ade80", "#e5e7eb"],
            borderWidth: 0
        }],
        centerText: "0%"
    },
    options: {
        // cutout: "70%",
        cutout: "85%",
        plugins: { legend: { display: false } }
    },
    plugins: [centerTextPlugin]
});

/* ===== 進捗更新 ===== */
function updateProgress() {
    const achieved = Math.min(totalDistance, goalDistance);
    const remaining = Math.max(goalDistance - achieved, 0);
    const percent = goalDistance > 0
        ? (achieved / goalDistance) * 100
        : 0;

    progressChart.data.datasets[0].data = [achieved, remaining];
    progressChart.config.data.centerText = `${percent.toFixed(1)}%`;
    progressChart.update();

    document.getElementById("distance").textContent =
        `今日の合計距離：${totalDistance.toFixed(2)} m`;
}

/* ===== 距離計算 ===== */
function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ===== GPS ===== */
function startTracking() {
    navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        if (accuracy > 80) return;

        if (lastLat === null) {
            lastLat = latitude;
            lastLon = longitude;
            return;
        }

        const dist = haversineDistance(lastLat, lastLon, latitude, longitude);
        if (dist < 1) return;

        totalDistance += dist;
        lastLat = latitude;
        lastLon = longitude;

        updateProgress();
    });
}

/* ===== 目標設定 ===== */
document.getElementById("goal-form").addEventListener("submit", e => {
    e.preventDefault();
    const val = Number(document.getElementById("goalInput").value);
    if (val <= 0) return alert("正しい目標を入れて");

    goalDistance = val;
    document.getElementById("goal").textContent =
        `今日の目標：${goalDistance} m`;

    updateProgress();
});

/* 初期化 */
updateProgress();
window.onload = startTracking;




</script>


</div>
</body>
</html>





