<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>現在地取得</title>
    <style>
        .progress-container {
            width: 100%;
            max-width: 400px;
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
        }
        </style>
        
</head>

<body>

    <ul>
        <li><a href="{% url 'kenkou:mission' %}"> ミッション</a></li>
        <li><a href="{% url 'kenkou:battle' %}"> たたかう</a></li>
    </ul>

    <form id="goal-form">
        <label>
            今日の目標距離（m）：
            <input type="number" id="goalDistance" min="1" step="1" placeholder="例：1500" required>
        </label>
        <button type="submit">設定</button>
    </form>

    <p id="goal">
        今日の目標：{{ goal_distance }} m
    </p>

    <p id="distance">
        今日の合計距離: {{ total_distance }} m
    </p>

    <p id="progress">
        進捗：0 %
    </p>

    <div class="progress-container">
        <div id="progress-bar"></div>
    </div>
    

    <script>
        let watchId = null;
        let lastLat = null;
        let lastLon = null;

        let totalDistance = {{ total_distance }};
        let goalDistance = {{ goal_distance|default:"0" }};
        // ====== 位置情報開始 ======
        function startTracking() {
            if (!navigator.geolocation) {
                alert("位置情報が使えません");
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                positionSuccess,
                err => console.error(err),
                { enableHighAccuracy: true }
            );
        }

        // ====== 表示更新 ======
        function updateView() {
    // 合計距離
    document.getElementById("distance").textContent =
        `今日の合計距離: ${totalDistance.toFixed(2)} m`;

    let percent = 0;
    if (goalDistance > 0) {
        percent = Math.min((totalDistance / goalDistance) * 100, 100);
    }

    // % 表示
    document.getElementById("progress").textContent =
        `進捗：${percent.toFixed(1)} %`;

    // グラフ（バー）
    document.getElementById("progress-bar").style.width =
        `${percent}%`;
}
        // ====== GPS成功 ======
        function positionSuccess(pos) {
            const { latitude: lat, longitude: lon, accuracy: acc } = pos.coords;
            if (acc > 80) return;

            if (lastLat === null || lastLon === null) {
                lastLat = lat;
                lastLon = lon;
                return;
            }

            const dist = haversineDistance(lastLat, lastLon, lat, lon);
            if (dist < 1) return;

            totalDistance += dist;
            localStorage.setItem("totalDistance", totalDistance);

            updateView();
            sendDistanceToServer(totalDistance);

            lastLat = lat;
            lastLon = lon;
        }

        // ====== 距離計算 ======
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) *
                Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // ====== サーバ送信 ======
        function sendDistanceToServer(distance) {
            fetch("{% url 'kenkou:location_receive' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ distance })
            });
        }

        // ====== 目標設定 ======
        document.getElementById("goal-form").addEventListener("submit", e => {
            e.preventDefault();

            const goalInput = document.getElementById("goalDistance");
            const goal = parseInt(goalInput.value);

            if (isNaN(goal) || goal <= 0) {
                alert("正しい目標距離を入力してください");
                return;
            }

            fetch("{% url 'kenkou:set_goal' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ goal })
            })
                .then(res => res.json())
                .then(data => {
                    goalDistance = data.goal;
                    document.getElementById("goal").textContent =
                        `今日の目標：${data.goal} m`;
                    updateView();
                    goalInput.value = "";
                });
        });

        // 初期化
        updateView();
        window.onload = startTracking;
    </script>





</body>

</html>