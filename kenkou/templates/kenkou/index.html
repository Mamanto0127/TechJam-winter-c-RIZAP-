{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>HabiQue</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'top.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .progress-chart {
            width: 140px;
            height: 140px;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>

<body>
<div class="app-container">
<!-- ===== ナビ ===== -->
<ul>
    <li><a href="{% url 'kenkou:mission' %}"><i class="fa-solid fa-circle-question"></i>ミッション</a></li>
    <li><a href="{% url 'kenkou:battle' %}"><i class="fa-solid fa-khanda"></i>たたかう</a></li>
    <li><a href="{% url 'kenkou:logs' %}"><i class="fa-solid fa-file-lines"></i>ログ</a></li>
</ul>

<!-- ===== 目標設定 ===== -->
<form id="goal-form">
    <input type="number" id="goalInput" placeholder="目標距離(m)">
    <button>設定</button>
</form>

<p id="goal">今日の目標：{{ goal_distance }} m</p>
<p id="distance">今日の合計距離：{{ total_distance }} m</p>

<!-- ===== 円グラフ ===== -->
<canvas id="progressChart" class="progress-chart"></canvas>

<script>
let lastLat = null;

// Djangoからの初期値
let totalDistance = parseFloat({{ total_distance|default:0 }});
let goalDistance = parseFloat({{ goal_distance|default:1000 }});

// ===== CSRFトークン =====
const csrftoken = '{{ csrf_token }}';

// ===== 中央テキストプラグイン =====
const centerTextPlugin = {
    id: "centerText",
    beforeDraw(chart) {
        const { ctx, width, height } = chart;
        const text = chart.config.data.centerText || "0%";
        ctx.save();
        ctx.font = "bold 40px sans-serif";
        ctx.fillStyle = "#111";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, width / 2, height / 2);
        ctx.restore();
    }
};

// ===== Chart 初期化 =====
const ctx = document.getElementById("progressChart").getContext("2d");
const progressChart = new Chart(ctx, {
    type: "doughnut",
    data: {
        datasets: [{
            data: [totalDistance, Math.max(goalDistance - totalDistance, 0)],
            backgroundColor: ["#4ade80", "#e5e7eb"],
            borderWidth: 0
        }],
        centerText: `${((totalDistance/goalDistance)*100).toFixed(1)}%`
    },
    options: {
        cutout: "85%",
        plugins: { legend: { display: false } }
    },
    plugins: [centerTextPlugin]
});

// ===== グラフ更新 =====
function updateProgress() {
    const achieved = Math.min(totalDistance, goalDistance);
    const remaining = Math.max(goalDistance - achieved, 0);
    const percent = goalDistance > 0
        ? (achieved / goalDistance) * 100
        : 0;

    progressChart.data.datasets[0].data = [achieved, remaining];
    progressChart.config.data.centerText = `${percent.toFixed(1)}%`;
    progressChart.update();

    document.getElementById("distance").textContent =
        `今日の合計距離：${totalDistance.toFixed(2)} m`;
}

// ===== サーバーに距離送信 =====
function sendDistanceToServer(distance) {
    fetch("{% url 'kenkou:location_receive' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ distance: distance })
    })
    .then(res => res.json())
    .then(data => console.log("distance saved:", data.total_distance))
    .catch(err => console.error(err));
}

// ===== 距離計算 =====
function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ===== GPS追跡 =====
let watchId = null;
function startTracking() {
    if (!navigator.geolocation) return alert("GPSが利用できません");

    if (watchId !== null) return; // 二重起動防止

    watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        if (accuracy > 80) return;

        if (lastLat === null) {
            lastLat = latitude;
            lastLon = longitude;
            return;
        }

        const dist = haversineDistance(lastLat, lastLon, latitude, longitude);
        if (dist < 1 || dist > 50) return; // 微小距離 or ワープ防止

        totalDistance += dist;
        lastLat = latitude;
        lastLon = longitude;

        updateProgress();
        sendDistanceToServer(totalDistance);
    }, err => console.error(err), { enableHighAccuracy: true, maximumAge: 1000 });
}

// ===== 目標設定 =====
document.getElementById("goal-form").addEventListener("submit", e => {
    e.preventDefault();
    const val = Number(document.getElementById("goalInput").value);
    if (val <= 0) return alert("正しい目標を入れて");

    goalDistance = val;
    document.getElementById("goal").textContent =
        `今日の目標：${goalDistance} m`;
    updateProgress();

    fetch("{% url 'kenkou:set_goal' %}", {   // ← URL名を 'set_goal' に修正
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ goal: val })
    })
    .then(res => res.json())
    .then(data => console.log("goal updated", data))
    .catch(err => console.error(err));
});

// ===== 初期化 =====
updateProgress();
window.onload = startTracking;
</script>
</div>
</body>
</html>
