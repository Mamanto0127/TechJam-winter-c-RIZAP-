<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾åœ¨åœ°å–å¾—</title>
</head>

<body>

    <ul>
        <li><a href="{% url 'kenkou:mission' %}"> ãƒŸãƒƒã‚·ãƒ§ãƒ³</a></li>
        <li><a href="{% url 'kenkou:battle' %}"> ãŸãŸã‹ã†</a></li>
    </ul>

    <p id="distance">
        ä»Šæ—¥ã®åˆè¨ˆè·é›¢: {{ total_distance }} m
    </p>


    <script>
        let watchId = null;
        let lastLat = null;
        let lastLon = null;

        function getTodayKey() {
            return new Date().toISOString().slice(0, 10);
        }

        // ğŸ”µ Django â†’ åˆæœŸå€¤
        let totalDistance = {{ total_distance }};

        // ğŸ”µ localStorage å„ªå…ˆ
        const todayKey = getTodayKey();
        const storedDate = localStorage.getItem("distanceDate");
        const storedDistance = parseFloat(localStorage.getItem("totalDistance"));

        if (storedDate === todayKey && !isNaN(storedDistance)) {
            totalDistance = storedDistance;
        } else {
            localStorage.setItem("totalDistance", totalDistance);
            localStorage.setItem("distanceDate", todayKey);
        }

        function updateView() {
            document.getElementById("distance").textContent =
                `ä»Šæ—¥ã®åˆè¨ˆè·é›¢: ${totalDistance.toFixed(2)} m`;
        }

        updateView();

        function startTracking() {
            if (!navigator.geolocation) {
                console.warn("Geolocation not supported");
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                positionSuccess,
                err => console.error(err),
                { enableHighAccuracy: true }
            );
        }

        function positionSuccess(pos) {
            const { latitude: lat, longitude: lon, accuracy: acc } = pos.coords;
            if (acc > 20) return;

            if (lastLat !== null && lastLon !== null) {
                const dist = haversineDistance(lastLat, lastLon, lat, lon);
                if (dist < 5) return;

                totalDistance += dist;
                localStorage.setItem("totalDistance", totalDistance);
                updateView();
                sendDistanceToServer(totalDistance);
            }

            lastLat = lat;
            lastLon = lon;
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) *
                Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function sendDistanceToServer(distance) {
            fetch("{% url 'kenkou:location_receive' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ distance })
            });
        }

        window.onload = startTracking;
    </script>




</body>

</html>