<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¾åœ¨åœ°å–å¾—</title>
</head>

<body>

  <ul>
    <li><a href="{% url 'kenkou:mission' %}"> ãƒŸãƒƒã‚·ãƒ§ãƒ³</a></li>
    <li><a href="{% url 'kenkou:battle' %}"> ãŸãŸã‹ã†</a></li>
  </ul>

  <button onclick="getLocation()">ç¾åœ¨åœ°ã‚’å–å¾—</button>

  <p id="location">ã¾ã å–å¾—ã—ã¦ã„ã¾ã›ã‚“</p>

  <script>
  function getLocation() {
    if (!navigator.geolocation) {
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      function(pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const time = Date.now();

        // ğŸ‘‡ ç”»é¢ã«è¡¨ç¤º
        document.getElementById("location").innerText =
          `ç·¯åº¦: ${lat}, çµŒåº¦: ${lon}`;

        // Djangoã¸é€ä¿¡
        sendToServer(lat, lon, time);
      },
      function(err) {
        document.getElementById("location").innerText =
          "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
        console.error(err);
      }
    );
  }

  function sendToServer(lat, lon, time) {
    fetch("{% url 'kenkou:location_receive' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        latitude: lat,
        longitude: lon,
        timestamp: time
      })
    });
  }
  </script>
</body>
</html>