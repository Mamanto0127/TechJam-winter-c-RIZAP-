<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>現在地取得</title>
</head>

<body>

  <ul>
    <li><a href="{% url 'kenkou:mission' %}"> ミッション</a></li>
    <li><a href="{% url 'kenkou:battle' %}"> たたかう</a></li>
  </ul>

  <button onclick="startTracking()">かいし</button>
  <button onclick = "stopTracking()">終わり</button>

  <div id="log"></div>

  <script>
let watchId = null;

function startTracking() {
    if (!navigator.geolocation) {
        alert("位置情報が使えません");
        return;
    }

    watchId = navigator.geolocation.watchPosition(
        positionSuccess,
        positionError,
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

function stopTracking() {
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
}

function positionSuccess(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const acc = pos.coords.accuracy;
    const time = Date.now();

    // 精度が悪いものは捨てる（重要）
    if (acc > 20) return;

    document.getElementById("log").innerHTML =
        緯度:${lat}<br>経度:${lon}<br>精度:${acc}m;

    sendLocation(lat, lon, time);
}

function positionError(err) {
    console.log(err);
}

function sendLocation(lat, lon, time) {
    fetch("{% url 'kenkou:location_receive' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            latitude: lat,
            longitude: lon,
            timestamp: time
        })
    });
}  </script>
</body>
</html>